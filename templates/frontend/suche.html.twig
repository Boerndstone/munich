{% extends 'base.html.twig' %}

{% block title %}Suche nach Schwierigkeit oder Erstbegeher{% endblock %}

{% block page_javascripts %}
	{{ encore_entry_script_tags('routeparams') }}
{% endblock %}

{% block body %}
{{ include('partials/_navigation.html.twig') }}
<main>
    <div class="container my-3">
        <section>
            <div class="py-3 mb-3 d-flex align-items-center justify-content-between">
                <h1 class="h2 mb-0 fw-medium">Suche nach Schwierigkeit oder Erstbegeher</h1>
            </div>
            <div class="row">
                <div class="col-12">
                    <!-- Grade Search Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Nach Schwierigkeit suchen</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ path('app_suche') }}">
                                <input type="hidden" name="search_type" value="grade">
                                <div class="row mb-3">
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label fw-medium">Gebiet auswählen:</label>
                                        <select class="form-select" name="area" id="area">
                                            <option value="">Alle Gebiete</option>
                                            {% for area in areas %}
                                                <option value="{{ area.slug }}" {% if selectedArea == area.slug %}selected{% endif %}>
                                                    {{ area.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-medium">Schwierigkeitsgrade auswählen:</label>
                                        <div class="row">
                                            {% for rangeKey, rangeData in gradeRanges %}
                                                <div class="col-2 col-lg-3 mb-2">
                                                    <div class="form-check">
                                                        <input 
                                                            class="form-check-input" 
                                                            type="checkbox" 
                                                            name="grades[]" 
                                                            value="{{ rangeKey }}" 
                                                            id="grade_{{ rangeKey }}"
                                                            {% if rangeKey in selectedGrades %}checked{% endif %}
                                                        >
                                                        <label class="form-check-label" for="grade_{{ rangeKey }}">
                                                            {{ rangeData.label }}
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-3 d-flex flex-wrap align-items-center">
                                            <button type="submit" class="btn btn-outline-secondary d-flex align-items-center me-2">
                                                <div class="magnifier me-2"></div>Nach Schwierigkeit suchen
                                            </button>
                                            <a href="{{ path('app_suche') }}" class="btn btn-outline-secondary mt-3 mt-lg-0 d-flex align-items-center">
                                                <div class="close me-2"></div>Zurücksetzen
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Search Results -->
                    {% if (searchType == 'grade' and selectedGrades is not empty) %}
                        <div class="row">
                            <div class="col-12">
                                <p class="mb-3 fw-medium stay-black">
                                    {% if searchType == 'firstascent' %}
                                        Suchergebnisse für "{{ query }}" <b>{{ totalRoutes }} Routen gefunden</b>
                                    {% else %}
                                        Suchergebnisse für ausgewählte Schwierigkeitsgrade <b>{{ totalRoutes }} Routen gefunden</b>
                                    {% endif %}
                                    {% if totalPages > 1 %}
                                        (Seite {{ currentPage }} von {{ totalPages }})
                                    {% endif %}
                                </p>
                                <hr />
                                {% if routes|length > 0 %}
                                    <div class="table-responsive">
                                        <table class="table trable-hover mb-0 small fw-medium 0">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Route</th>
                                                    <th>Fels</th>
                                                    <th>Gebiet</th>
                                                    <th>Schwierigkeit</th>
                                                    <th>Erstbegeher</th>
                                                    <th>Jahr</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for route in routes %}
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex items-bottom">
                                                                {% if route.rock and route.rock.area %}
                                                                    <a href="{{ path('show_rock', {'areaSlug': route.rock.area.slug, 'slug': route.rock.slug}) }}#{{ route.name|replace({' ': ''})|lower }}" 
                                                                    class="text-decoration-none fw-medium me-1">
                                                                        {{ route.name|raw }}
                                                                    </a>
                                                                {% else %}
                                                                    <span class="text-decoration-none fw-medium me-1">{{ route.name }}</span>
                                                                {% endif %}
                                                                <span class="mb-0 pb-0" style="line-height: 0;" data-controller="routeparams" data-routeparams-rating="{{ route.rating }}" data-routeparams-protection="{{ route.protection }}" data-routeparams-route-rock-quality="{{ route.rockQuality }}">
                                                                    <span data-routeparams-target="rating"></span>
                                                                    <span data-routeparams-target="protection"></span>
                                                                    <span data-routeparams-target="route-rock-quality"></span>
                                                                </span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {% if route.rock and route.rock.area %}
                                                                <a href="{{ path('show_rock', {'areaSlug': route.rock.area.slug, 'slug': route.rock.slug}) }}" 
                                                                class="text-decoration-none">
                                                                    {{ route.rock.name }}
                                                                </a>
                                                            {% elseif route.rock %}
                                                                <span class="text-muted">{{ route.rock.name }}</span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.area %}
                                                                <a href="{{ path('show_rocks', {'slug': route.area.slug}) }}" 
                                                                class="text-decoration-none">
                                                                    {{ route.area.name }}
                                                                </a>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.grade %}
                                                                <span class="badge bg-secondary">{{ route.grade }}</span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.firstAscent %}
                                                                {{ route.firstAscent }}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.yearFirstAscent %}
                                                                {{ route.yearFirstAscent }}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>                                                       
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                        <h5 class="">Keine Routen gefunden</h5>
                                        <p class="mb-5">Für den Suchbegriff "{{ query }}" wurden keine Routen gefunden. Versuchen Sie es mit einem anderen Namen.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Pagination - Only for Grade Search -->
                                {% if searchType == 'grade' and totalPages > 1 %}
                                    <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light rounded">
                                        <div class="text-muted small">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Zeige {{ ((currentPage - 1) * 30) + 1 }}-{{ currentPage * 30 > totalRoutes ? totalRoutes : currentPage * 30 }} von {{ totalRoutes }} Routen
                                        </div>
                                        
                                        <nav aria-label="Suchergebnisse Navigation">
                                            <ul class="pagination justify-content-center pagination-sm mb-0">
                                                <!-- Previous Button -->
                                                {% if currentPage > 1 %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="{{ path('app_suche', app.request.query.all|merge({'page': currentPage - 1})) }}" aria-label="Vorherige Seite">
                                                            <span class="chevron-left d-block"></span>
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item disabled">
                                                        <span class="page-link">
                                                            <span class="chevron-left d-block"></span>
                                                        </span>
                                                    </li>
                                                {% endif %}
                                                
                                                <!-- Page Numbers -->
                                                {% set startPage = currentPage > 3 ? currentPage - 2 : 1 %}
                                                {% set endPage = currentPage + 2 < totalPages ? currentPage + 2 : totalPages %}
                                                
                                                {% if startPage > 1 %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="{{ path('app_suche', app.request.query.all|merge({'page': 1})) }}">1</a>
                                                    </li>
                                                    {% if startPage > 2 %}
                                                        <li class="page-item disabled">
                                                            <span class="page-link">...</span>
                                                        </li>
                                                    {% endif %}
                                                {% endif %}
                                                
                                                {% for page in startPage..endPage %}
                                                    {% if page == currentPage %}
                                                        <li class="page-item active">
                                                            <span class="page-link">{{ page }}</span>
                                                        </li>
                                                    {% else %}
                                                        <li class="page-item">
                                                            <a class="page-link" href="{{ path('app_suche', app.request.query.all|merge({'page': page})) }}">{{ page }}</a>
                                                        </li>
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                {% if endPage < totalPages %}
                                                    {% if endPage < totalPages - 1 %}
                                                        <li class="page-item disabled">
                                                            <span class="page-link">...</span>
                                                        </li>
                                                    {% endif %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="{{ path('app_suche', app.request.query.all|merge({'page': totalPages})) }}">{{ totalPages }}</a>
                                                    </li>
                                                {% endif %}
                                                
                                                <!-- Next Button -->
                                                {% if currentPage < totalPages %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="{{ path('app_suche', app.request.query.all|merge({'page': currentPage + 1})) }}" aria-label="Nächste Seite">
                                                            <span class="chevron-right d-block"></span>
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item disabled">
                                                        <span class="page-link">
                                                            <span class="chevron-right d-block"></span>
                                                        </span>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </nav>
                                    </div>
                                {% endif %}

                    <hr class="my-4">

                    <!-- FirstAscent Search Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Nach Erstbegeher suchen</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ path('app_suche') }}">
                                <input type="hidden" name="search_type" value="firstascent">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="searchInput" class="form-label">Erstbegeher:</label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="searchInput" 
                                                name="q" 
                                                value="{{ searchType == 'firstascent' ? query : '' }}" 
                                                placeholder="Namen des Erstbegehers..."
                                                autocomplete="off"
                                            >
                                        </div>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-outline-secondary w-100">
                                            <i class="fas fa-search me-2"></i>Suchen
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Search Results -->
                    {% if (searchType == 'firstascent' and query is not empty) %}
                        <div class="row">
                            <div class="col-12">
                                <p class="mb-3 fw-medium stay-black">
                                    {% if searchType == 'firstascent' %}
                                        Suchergebnisse für "{{ query }}" <b>{{ routes|length }} Routen gefunden</b>
                                    {% else %}
                                        Suchergebnisse für ausgewählte Schwierigkeitsgrade <b>{{ routes|length }} Routen gefunden</b>
                                    {% endif %}
                                </p>
                                <hr />
                                {% if routes|length > 0 %}
                                    <div class="table-responsive">
                                        <table class="table trable-hover mb-0 small fw-medium 0">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Route</th>
                                                    <th>Fels</th>
                                                    <th>Gebiet</th>
                                                    <th>Schwierigkeit</th>
                                                    <th>Erstbegeher</th>
                                                    <th>Jahr</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for route in routes %}
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex items-bottom">
                                                            {% if route.rock and route.rock.area %}
                                                                <a href="{{ path('show_rock', {'areaSlug': route.rock.area.slug, 'slug': route.rock.slug}) }}#{{ route.name|replace({' ': ''})|lower }}" 
                                                                class="text-decoration-none fw-medium me-1">
                                                                    {{ route.name }}
                                                                </a>
                                                            {% else %}
                                                                <span class="text-decoration-none fw-medium me-1">{{ route.name }}</span>
                                                            {% endif %}
                                                            <span class="mb-0 pb-0" style="line-height: 0;" data-controller="routeparams" data-routeparams-rating="{{ route.rating }}" data-routeparams-protection="{{ route.protection }}" data-routeparams-route-rock-quality="{{ route.rockQuality }}">
 																<span data-routeparams-target="rating"></span>
 																<span data-routeparams-target="protection"></span>
 																<span data-routeparams-target="route-rock-quality"></span>
 															</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {% if route.rock and route.rock.area %}
                                                                <a href="{{ path('show_rock', {'areaSlug': route.rock.area.slug, 'slug': route.rock.slug}) }}" 
                                                                class="text-decoration-none">
                                                                    {{ route.rock.name }}
                                                                </a>
                                                            {% elseif route.rock %}
                                                                <span class="text-muted">{{ route.rock.name }}</span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.area %}
                                                                <a href="{{ path('show_rocks', {'slug': route.area.slug}) }}" 
                                                                class="text-decoration-none">
                                                                    {{ route.area.name }}
                                                                </a>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.grade %}
                                                                <span class="badge bg-secondary">{{ route.grade }}</span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.firstAscent %}
                                                                {{ route.firstAscent }}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if route.yearFirstAscent %}
                                                                {{ route.yearFirstAscent }}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                        <h5 class="">Keine Routen gefunden</h5>
                                        <p class="mb-5">Für den Suchbegriff "{{ query }}" wurden keine Routen gefunden. Versuchen Sie es mit einem anderen Namen.</p>
                                {% endif %}
                                
                                
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>
    </div>
</main>
{% endblock %}