{% extends '@!EasyAdmin/layout.html.twig' %}

{% block page_title %}
    Pfad bearbeiten - {{ rock.name }}
{% endblock %}

{% block head_stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
    </style>
{% endblock %}

{% block main %}
    <div class="content-header">
        <div class="content-header-title">
            <h1 class="title">Pfad bearbeiten für: {{ rock.name }}</h1>
        </div>
    </div>

    <div class="content-body">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Zeichnen Sie den Pfad auf der Karte. Sie können Polylinien, Polygone oder Marker hinzufügen.
                            Der Startpunkt der Karte ist {% if rock.lat and rock.lng %}die Position des Felsens{% else %}ein Standardpunkt{% endif %}.
                        </p>

                        <div 
                            class="container"
                            data-controller="admin-draw-map"
                            data-admin-draw-map-lat-value="{{ rock.lat ?? 49.01 }}"
                            data-admin-draw-map-lng-value="{{ rock.lng ?? 11.95 }}"
                            data-admin-draw-map-zoom-value="{{ rock.zoom ?? 16 }}"
                            data-admin-draw-map-coordinates-value="{{ (rock.pathCoordinates ?? [])|json_encode|e('html_attr') }}"
                        >
                            <div class="row">
                                <div class="col">
                                    <div id="map" data-admin-draw-map-target="map"></div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <button class="btn btn-info" type="button" data-admin-draw-map-target="exportButton" data-action="admin-draw-map#exportDrawings">
                                        <i class="fa fa-download"></i> Export Drawings
                                    </button>
                                </div>
                            </div>

                            <form method="post" action="{{ path('admin_rock_geolocation', {rockId: rock.id}) }}" class="mt-4">
                                <input type="hidden" name="_token" value="{{ csrf_token('rock_geolocation') }}">
                                
                                <div class="form-group mb-3">
                                    <label for="path_coordinates" class="form-label">Pfad-Koordinaten (JSON):</label>
                                    <textarea 
                                        id="path_coordinates" 
                                        name="path_coordinates" 
                                        class="form-control font-monospace" 
                                        rows="8"
                                        data-admin-draw-map-target="coordinates"
                                    >{{ (rock.pathCoordinates ?? [])|json_encode(constant('JSON_PRETTY_PRINT')) }}</textarea>
                                    <small class="form-text text-muted">
                                        Diese Koordinaten werden automatisch aktualisiert, wenn Sie auf der Karte zeichnen.
                                    </small>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-save"></i> Speichern
                                    </button>
                                    <a href="{{ detailUrl }}" class="btn btn-secondary">
                                        <i class="fa fa-times"></i> Abbrechen
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

